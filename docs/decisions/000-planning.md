# Планирование: анализ, идентификация проблем и поиск решений

## Context and Problem Statement

- С ростом заказов часть клиентов B2C перестала получать их в срок.
- После открытия API MES еще больше клиентов B2C, а теперь и B2B, не получают заказы.

При этом мощностей производства хватает, чтобы обеспечить рост количества заказов.

- Дашборд MES с заказами стал дольше открываться.

Добавление фильтрации и пагинации не помогло.

- Релизы регулярно задерживаются на ~месяц из-за критических ошибок в ПО.

## Considered Options

Сейчас 1 экземпляр MES API выполняет большое количество функционала одновременно:

- принимает заказы от CRM.
- принимает заказы от API и публикует их в CRM.
- записывает заказы в свою БД.
- читает данные из своей БД и S3 для отображения на сайте MES.
- считает стоимость продукции для B2C и B2B клиентов, читает данные из S3.

При возросшей нагрузке приложение может просто не справляться со всем функционалом одновременно, повышая вероятность
ошибок по timeout-у. По-хорошему, разбить MES на микросервисы и масштабировать точечно, но в текущей ситуации нам
нужно более оперативное решение. Можно проверить нагрузку на текущие сервисы, посмотреть их загруженность,
масштабировать систему по необходимости. Также можно посмотреть в сторону оптимизации операций с БД: добавить кэш,
реплики, шардирование или CQRS.

Если заказы не доставляются в срок, значит, они не отображаются на сайте MES и не выполняются операторами. Возможны
варианты:

- Если подтверждение заказа в CRM происходит до отправки сообщения в брокер, но оно не отправилось.
- Брокер не справляется с нагрузкой и теряет сообщения.
- MES не успевает обработать сообщения из брокера и теряет их при ошибках.
- При обработке сообщения MES не удается записать в БД заказ из-за timeout-а или других ошибок. Проблема БД MES.
- Ошибки при отправке сообщений из MES в CRM или записи заказа в БД магазина. Проблемы брокера или БД магазина.

Заказы могут теряться в совершенно разных местах, и причем одновременно.
Однозначно сказать сейчас нельзя, можно попытаться посмотреть существующие логи (если есть), но лучшим вариантом
будет добавить мониторинг и трассировку запросов, чтобы точно понять загрузку сервисов и проблемные места.

При отсутствии автотестов цикл разработки сильно снижается, потому что разработчикам нужно ждать обратную связь от
единственного тестировщика. Стоит покрыть ПО автоматическими тестами: unit, интеграционными, E2E. Рассмотреть вариант
найма еще одного тестировщика.

## Decision Outcome

В порядке приоритета в течение 2 следующих кварталов:

- Добавить мониторинг загрузки сервисов, отследить ключевые параметры (CPU/GPU, RAM, RPS/QPS), чтобы понять, какие
  из них перегружены.
  Нанять еще одного DevOps/SRE, чтобы вводить и поддерживать мониторинг, а также масштабировать систему.

- Масштабировать перегруженные сервисы горизонтально/вертикально, включая БД и брокеры.

- Добавить трассировку, чтобы понять проблемные места.

- Добавить паттерны Outbox/Inbox, если они не реализованы, для атомарной записи в БД и отправки сообщений в
  брокер. Это поможет избежать потери сообщений при ошибках.

- Рассмотреть кэш, реплики, шардирование и CQRS для БД, чтобы ускорить работу с ней, снизить стоимость запросов. Менее
  приоритетно, так как краткосрочно можно просто вертикально масштабировать БД и брокеры.

- Добавить логирование. Сейчас у нас немного экземпляров сервисов, можно написать логи, но смотреть их руками. Уступает
  трассировке по приоритету, так как без нее трудно понять, где искать проблему.

- Написать автотесты, чтобы ускорить разработку. Нанять еще одного тестировщика.

В приоритете первые 3.
В будущем можно рассмотреть разбиение MES на микросервисную архитектуру и найм большего числа разработчиков для более
оперативного решения проблем, поддержания и расширения функционала.

Целевая архитектура:

<img src="../diagrams/to_be/containers.drawio.svg" alt="C4 диаграмма контейнеров To Be архитектуры"/>

### Consequences

- Система сможет обрабатывать большее количество заказов без ошибок.
- Дашборд MES сможет быстрее отображать заказы.
- Команда сможет узнавать о проблемах раньше клиентов и быстрее на них реагировать.
- Время на отладку системы сократится.
- Разработчики быстрее будут находить ошибки, тестировать свои изменения, выпускать релизы.
