# Мониторинг: выбор технологий, подходов, метрик и планирование

## Context and Problem Statement

Текущий мониторинг ограничен веб-метриками в Яндекс Метрике и не охватывает сервисные и инфраструктурные показатели
(CPU, RAM, диск, БД, очереди, ошибки, запросы и т.д.). Для полноценной диагностики требуется новая система мониторинга.
Она поможет отслеживать нагрузку и состояние системы, выявлять проблемы и аномалии, а также оптимизировать
производительность.

## Considered Options

### Технологии

#### Time series database

- Prometheus: самое популярное решение, но не поддерживает high availability (HA): горизонтальное масштабирование,
  шардирование, долгосрочное хранение данных.

- Thanos: надстройка над Prometheus, делающая его HA. CNCF, возраст: 8 лет, более широкая поддержка на GitHub, чем
  Mimir. Не multi-tenant по умолчанию, но можно использовать метки/теги.

- Mimir: собственная HA БД от Grafana Labs, проще интеграция с Grafana, multi-tenant по умолчанию, работает с S3.
  Возраст: 2 года, меньше сообщество, но активно развивается.

- VictoriaMetrics: drop-in альтернатива Prometheus, более легковесная, нет нативной pull-модели, нет встроенного
  alert-решения, возраст: 7 лет.

#### Формат метрик

- Prometheus: только pull экспорт, ограниченные метаданные.

- OpenTelemetry Metrics: более гибкие теги/метки/метаданные, широкая модель метрик, поддержка protobuf, push и
  pull экспорт.

### Подходы и метрики

#### USE - Utilization, Saturation, Errors

Лучше всего подходит для отслеживания нагрузки и деградации сервисов, инфраструктуры. Отслеживать БД, брокеры,
контейнеры, серверы.

Для определения порогов насыщенности лучше провести стресс-тестирование и взять 70-80% от значения, когда начинаются
ошибки. Если нет возможности проводить стресс-тестирование, то наблюдать за метриками в течение пары недель-месяцев,
предварительно поставив стандартные значения: CPU/RAM - 80%, Disk I/O - 70-80%, длина очереди RabbitMQ - 50.

Метрики на каждом из сервисов:

- CPU: % использования
- RAM: % использования, Swap
- Disk I/O: % использования, скорость чтения/записи, длина очереди операций, свободное место
- Network I/O: % использования, скорость чтения/записи, количество подключений, packet loss

Дополнительно для БД/S3: количество подключений/блокировок.
Для RabbitMQ: длина очереди.

В качестве меток использовать именования сервисов/таблиц/очередей, окружение (prod, stage, dev), IP адреса.

#### RED - Rate, Errors, Duration

Походит для мониторинга API, запросов.

Метрики:

- БД/S3: queries per second (QPS) c разделением на типы запросов (SELECT, INSERT, UPDATE, DELETE), время обработки
  запроса, количество ошибок (timeout, deadlock).
- RabbitMQ: скорость публикации/обработки сообщений, время обработки (как полное: от публикации до выполнения, так и
  только обработчика), количество ошибок (reject, длина dead-letter).
- Сервисы/API: requests per second (RPS), время обработки запроса, количество не 2xx ответов. Всё в разбивке по
  endpoint-ам, пользователям, статусам.

#### Four Golden Signals - Latency, Traffic, Errors, Saturation

В целом перекрывается с RED и USE, учитывая, что RED базируется на 4GS. Сочетание RED и USE зачастую покрывает все
случаи 4GS, и можно не использовать его без необходимости.

#### Service Level Indicators (SLI)

Внешние показатели (время сессии, конверсия, количество пользователей/заказов/возвратов, etc.) уже отслеживаются в
Яндекс Метрике.
Но нужно также добавить другие бизнес-показатели: количество просроченных заказов, время на обработку и т.д. Разбить на
тип клиента, заказа.

## Decision Outcome

Так как мы строим мониторинг с нуля, то можно построить его на OpenTelemetry + Mimir + Grafana. Это даст более легкое
и простое решение, чем Prometheus + Thanos, упростит интеграцию с Grafana, более гибкие метаданные и метрики, чем
Prometheus-формат. Для подбора метрик использовать USE для инфраструктуры и RED для API.

- Развернуть Mimir, Grafana.
- Добавить OpenTelemetry в сервисы.
- Установить шаблонные дашборды и инструментаторы для сервисов, БД, брокеров.
- Проанализировать, какие метрики действительно нужны для нас, посмотреть, что есть из USE/RED, убрать ненужные,
  добавить свои.
- Установить целевые значения метрик (SLO) и настроить оповещения на них: сообщение или звонок в зависимости от
  критичности. Инфраструктура у нас не в K8s, поэтому вариант с авто масштабированием пока выглядит
  сложно реализуемым.

### Consequences

- Быстрая реакция на аномалии: ошибки, задержки, перегрузки
- Масштабируемость и HA из коробки
