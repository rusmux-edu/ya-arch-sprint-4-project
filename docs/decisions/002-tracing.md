# Трассировка: выбор технологий, сервисов и планирование

## Context and Problem Statement

В текущей архитектуре возникают случаи значительных задержек доставки заказов, однако отсутствует механизм, позволяющий
точно определить, где именно происходят ошибки. Мониторинг предоставляет лишь верхнеуровневую информацию о состоянии
системы, не позволяя проследить путь запроса и локализовать проблему. Логирование, в свою очередь, не отражает полный
путь запроса и время выполнения на всех этапах. Покрывать это всё логами будет слишком дорого для хранения и сложно для
сопоставления логов одного заказа. Чтобы иметь возможность отследить путь проблемных запросов во всей системе и
оперативно выявлять узкие места, необходимо ввести трассировку.

Распределенная трассировка:

- Уменьшит время на идентификацию проблемы, так как трейсы позволят быстро видеть цепочку вызовов и узкие места,
  существенно уменьшая ручной разбор логов.

- Уменьшит Mean Time To Recovery (MTTR) - среднее время восстановления системы после инцидента, так как ускорит
  локализацию проблемы.

- Даст возможность видеть распределение времени обработки по сервисам, позволяя расставлять приоритеты по улучшению
  системы.

- Поможет поддерживать/улучшать SLO/SLA – целевые метрики бизнеса, доступности, скорости обработки заказов. Быстрее
  решение проблем -> выше SLA, быстрее выполняются заказы.

- Увеличивает общую удовлетворенность системой пользователями. Меньше задержек, ошибок, выше оценка сервиса клиентами,
  больше заказов.

## Considered Options

### Технологии

- Jaeger — максимальная поддержка/документация/гибкость поиска.

- ElasticSearch — полнотекстовый поиск, с версии 7.11 бесплатна лишь базовая версия, в которой нет RBAC, требует много
  ресурсов.

- OpenSearch — FOSS, потребляет ещё больше ресурсов и медленнее, чем ElasticSearch, UX хуже, но встроена безопасность.

- Cassandra — колоночная БД, хорошо масштабируется, но нет индексов и полнотекстового поиска.

- Tempo (Grafana Labs) — совместим с OpenTelemetry, лёгкая интеграция с Grafana/Loki/Mimir, экономичен по ресурсам,
  легко масштабируем, так как работает c S3, но ограничен TraceQL (поиск только по атрибутам).

- Elastic APM — тесно связан с ELK-стеком, гибкий, но ресурсоёмкий, требует платной лицензии.

- OpenSearch Trace Analytics — малопопулярен, слабая документация, зависит от OpenSearch.

- Zipkin — морально устарел, ограниченная функциональность, низкая гибкость.

### Сервисы

Однозначно нужно проследить запросы из CRM в MES и наоборот, так как это ключевые сервисы системы, а MES - потенциально
перегруженный сервис, и между ними брокер, в котором могут теряться сообщения. Запросы от CRM/MES могут не доходить до
соответствующих API или неправильно обрабатываться.

Сайт магазина и его API представляют меньший интерес, так как не доставляются заказы, уже подтвержденные в CRM, то есть
они до туда доходят.

### Метаданные

Помимо стандартного набора данных (trace/span/parent/user/order id, start/end/duration time) можно включить тип метода
запроса для API и БД, очередь MQ, IP сервера если будет горизонтальное масштабирование.

## Decision Outcome

Tempo + Grafana. Grafana предоставляет IAM-систему и базовый RBAC, ограничивающие доступ к определенным
ресурсам. Для более гибкого управления можно использовать сторонние инструменты. Добавить многофакторную идентификацию и
настроить HTTPS или подключение только по внутреннему VPN. Доступ к трейсам можно ограничить только для выбранных
сотрудников поддержки. Помимо этого Grafana ведет свои логи, позволяющие проводить аудит доступа к данным.

Однако если данных мониторинга и логирования хватит для разрешения текущих проблем, то срочной необходимости в
трассировке нет, и можно сосредоточиться на более важных задачах. Также нецелесообразно его внедрять, если основная
проблема в системе MES и не представляется возможным оперативно инструментировать её, если разработчики не имеют
большого представления о её внутренней работе.

### Consequences

- Возможность быстро находить и устранять проблемы в системе
- Упрощённая настройка и поддержка.
- Экономия ресурсов и стоимости за счёт хранения в S3.
- Отсутствие полнотекстового поиска, только по атрибутам.
