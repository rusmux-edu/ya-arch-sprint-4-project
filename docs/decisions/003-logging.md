# Логирование: выбор технологий, сервисов и планирование

## Context and Problem Statement

Для понимания работы и состояния системы с точки зрения бизнес и программных процессов требуется
внедрение логирования. В отличие от общего мониторинга, логирование может предоставить больше информации о внутренней
работе системы. Трассировка позволяет локализовать проблемы, но не объясняет их причину и не предоставляет
дополнительный контекст. Кроме того, хранение большого объёма трейсов требует значительных ресурсов, поэтому
логирование необходимо как более дешевый способ получения детальной информации при отладке и анализе системы.

Логирование:

- Ведет аудит действий, что позволяет быстро узнать, кто что сделал в критические моменты, увеличивая безопасность.

- Уменьшит Mean Time To Recovery (MTTR) - среднее время восстановления системы после инцидента, так как ускорит
  понимание причин проблемы.

- Делает систему воспроизводимой. Даже через недели можно четко отследить, что произошло с заказом.

## Considered Options

### Технологии

- ELK Stack (Elasticsearch, Logstash, Kibana) — платный с версии 7.11, но доступна бесплатная базовая версия.
  Поддерживает полнотекстовый поиск, но требует значительных ресурсов и сложен в настройке. Нет бесплатного RBAC.

- OpenSearch Stack — FOSS, форк Elasticsearch, более ресурсоёмкий, медленнее, но со встроенной безопасностью.

- Loki (Grafana Labs) — простая интеграция с Grafana, легче архитектура и эксплуатация, но нет индексов (поиск только по
  метаданным), поддерживает хранение в S3.

- Splunk - комплексное решение для мониторинга сервисов, полностью платное и дорогое, больше подходит для крупных
  компаний.

### Уровни логов

Все логи должны содержать необходимые атрибуты: время, id пользователя/заказа, тип действия, стоимость, название
очереди, файла, статус. Логи должны быть структурированы (например, в формате JSON) и содержать метаданные, чтобы их
можно было легко фильтровать и искать.

#### INFO

- Создание/изменение/удаление сущностей (заказов, пользователей, 3D файлов и т.д.)
- Запросы для подсчета стоимости изделия
- Отправка/обработка сообщений

#### WARN

- Повторные запросы к API, сообщения, попытки подключения

#### ERROR

- Любые ошибки: валидации, обработки, расчета, запросов к API, DB, S3, брокеру

### Сервисы

Так как мы не можем по условию встроить и трассировку, и логирование во все сервисы, то последнее можно использовать для
сайта магазина и его API. В сервисах CRM и MES стоит использовать трассировку, чтобы идентифицировать узкое место.

## Decision Outcome

Решение зависит от существующей инфраструктуры:

- Если в системе уже есть логирование (особенно с неструктурированными логами), целесообразно использовать
  OpenSearch Stack, чтобы иметь возможность искать по тексту существующие логи без структуры и меток.

- Если логирование внедряется с нуля, предпочтение отдается Loki и правильно структурированным логам с нужными
  метками, тегами и атрибутами. По необходимости можно добавить кэш для самых последних логов.

У обоих решений есть IAM и RBAC, позволяющие ограничивать доступ к логам только для нужных людей. Логи не должны
содержать личную информацию, при необходимости можно использовать анонимизацию.

Длительность хранения логов зависит от их типа и уровня. Для логов уровня безопасности и аудита: 6-12 месяцев, ошибки,
критичные логи, бизнес-события: 1-3, остальные - 1. Можно добавить уведомления в виде сообщений или звонков для
критичных событий, поставить пороговые значения для их частоты, чтобы замечать аномалии. Для серьезного анализа можно
интегрировать с инструментами машинного обучения для детекции отклонений.

В дополнение к обычному логированию стоит использовать Sentry для быстрого получения информации об ошибках в момент,
когда они происходят. Он автоматически позволяет ловить все ошибки, группировать их, передавать контекст, стек
вызовов, что избавляет от ручного поиска по логам.

### Consequences

- Понимание работы системы и её внутренних процессов.
- Упрощение поиска и анализа логов, что позволяет быстрее находить и исправлять ошибки.

Если выбран OpenSearch:

- Сложность встраивания
- Высокая нагрузка на инфраструктуру.
- Поддержка полнотекстового поиска.

Если выбран Loki:

- Простота эксплуатации, экономия на инфраструктуре.
- Отсутствие полнотекстового поиска — только по метаданным.
